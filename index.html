<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Observatoire DPE - Compact</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.fullscreen/1.6.0/Control.FullScreen.min.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
  <style>
    :root { --brand: #3b82f6; }
    body { background-color: #f8f9fa; font-family: system-ui, sans-serif; font-size: 0.9rem; }
    .brand-icon { background: var(--brand); color: white; border-radius: 5px; }
    #map { height: 600px; width: 100%; border-radius: 0.5rem; z-index: 1; }
    .custom-pin { border-radius: 50%; border: 2px solid white; box-shadow: 0 3px 6px #00000050; color: white; display: flex; align-items: center; justify-content: center; }
    th.sortable { cursor: pointer; user-select: none; } th.sortable:hover { background: #e2e8f0; }
    .filter-badge { cursor: pointer; transition: 0.2s; } .filter-badge:hover { opacity: 0.8; }
    .col-hidden { display: none !important; }
  </style>
</head>
<body>
  <div class="container my-3">
    <header class="d-flex align-items-center mb-3 p-3 bg-white rounded shadow-sm border-bottom">
      <div class="brand-icon p-2 me-3"><i class="bi bi-building-check fs-4"></i></div>
      <div><h1 class="h5 mb-0 fw-bold">Observatoire DPE</h1><small class="text-muted">Données ADEME</small></div>
    </header>

    <div class="card shadow-sm mb-3 border-0">
      <div class="card-body py-3">
        <div class="row g-2">
          <div class="col-md-3">
            <label class="fw-bold text-muted small">CODE POSTAL</label>
            <input type="text" class="form-control form-control-sm" id="postal" value="44600" placeholder="ex: 44000">
          </div>
          <div class="col-md-3">
            <label class="fw-bold text-muted small">TYPE</label>
            <div class="d-flex gap-2">
              <div class="form-check"><input class="form-check-input" type="checkbox" id="tApp" checked value="appartement"><label class="form-check-label">Appart.</label></div>
              <div class="form-check"><input class="form-check-input" type="checkbox" id="tMai" checked value="maison"><label class="form-check-label">Maison</label></div>
              <div class="form-check"><input class="form-check-input" type="checkbox" id="tImm" checked value="immeuble"><label class="form-check-label">Imm.</label></div>
            </div>
          </div>
          <div class="col-md-3">
            <label class="fw-bold text-muted small">DPE</label>
            <div class="d-flex gap-1 flex-wrap" id="grades">
              <input type="checkbox" class="btn-check" id="gA" checked value="A"><label class="btn btn-outline-success btn-sm p-0 px-1" for="gA">A</label>
              <input type="checkbox" class="btn-check" id="gB" checked value="B"><label class="btn btn-outline-success btn-sm p-0 px-1" for="gB">B</label>
              <input type="checkbox" class="btn-check" id="gC" checked value="C"><label class="btn btn-outline-success btn-sm p-0 px-1" for="gC">C</label>
              <input type="checkbox" class="btn-check" id="gD" checked value="D"><label class="btn btn-outline-warning btn-sm p-0 px-1" for="gD">D</label>
              <input type="checkbox" class="btn-check" id="gE" checked value="E"><label class="btn btn-outline-warning btn-sm p-0 px-1" for="gE">E</label>
              <input type="checkbox" class="btn-check" id="gF" checked value="F"><label class="btn btn-outline-danger btn-sm p-0 px-1" for="gF">F</label>
              <input type="checkbox" class="btn-check" id="gG" checked value="G"><label class="btn btn-outline-danger btn-sm p-0 px-1" for="gG">G</label>
            </div>
          </div>
          <div class="col-md-3">
            <label class="fw-bold text-muted small">DATES</label>
            <div class="d-flex gap-1">
              <input type="date" class="form-control form-control-sm" id="dStart">
              <input type="date" class="form-control form-control-sm" id="dEnd">
            </div>
          </div>
        </div>
        <div class="row g-2 mt-1 align-items-end">
          <div class="col-6 col-md-2"><input type="number" class="form-control form-control-sm" id="sMin" placeholder="Surf. Min"></div>
          <div class="col-6 col-md-2"><input type="number" class="form-control form-control-sm" id="sMax" placeholder="Surf. Max"></div>
          <div class="col-6 col-md-2"><input type="number" class="form-control form-control-sm" id="limit" value="100" max="1000"></div>
          <div class="col-12 col-md-6 d-flex gap-2">
            <button id="searchBtn" class="btn btn-primary btn-sm flex-grow-1" style="background:var(--brand)">Rechercher</button>
            <div class="dropdown">
              <button class="btn btn-outline-secondary btn-sm" data-bs-toggle="dropdown"><i class="bi bi-layout-three-columns"></i></button>
              <ul class="dropdown-menu dropdown-menu-end p-2" id="colToggles"></ul>
            </div>
          </div>
        </div>
        <div id="badges" class="mt-2"></div>
      </div>
    </div>

    <ul class="nav nav-tabs nav-fill mb-2" role="tablist">
      <li class="nav-item"><button class="nav-link active py-1" data-bs-toggle="tab" data-bs-target="#list">Liste</button></li>
      <li class="nav-item"><button class="nav-link py-1" data-bs-toggle="tab" data-bs-target="#mapView">Carte</button></li>
    </ul>

    <div class="tab-content">
      <div class="tab-pane fade show active" id="list">
        <div id="msg" class="text-center py-4 text-muted"><i class="bi bi-search fs-1"></i><br>Lancer une recherche</div>
        <div id="resBox" class="d-none">
          <span class="badge bg-secondary mb-1" id="count">0</span>
          <div class="table-responsive bg-white border rounded" style="max-height:600px">
            <table class="table table-hover table-sm mb-0 small align-middle" id="table">
              <thead class="table-light sticky-top"></thead><tbody></tbody>
            </table>
          </div>
        </div>
      </div>
      <div class="tab-pane fade" id="mapView"><div id="map"></div></div>
    </div>
  </div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.fullscreen/1.6.0/Control.FullScreen.min.js"></script>
<script>
  const $ = (id) => document.getElementById(id);
  const C = {
    api: 'https://data.ademe.fr/data-fair/api/v1/datasets/dpe03existant/lines',
    cols: { A:'#319834', B:'#33cc31', C:'#cbfc34', D:'#fbfe06', E:'#fbcc04', F:'#f68e1e', G:'#ef1d26', Def:'#cbd5e1' }
  };

  const F = {
    cap: s => s ? s[0].toUpperCase() + s.slice(1) : '-',
    num: n => n ? Math.round(n).toLocaleString() : '-',
    bad: (v, t) => `<span class="badge border text-dark" style="background:${C.cols[v]||C.cols.Def};width:25px">${v||'-'}</span>`
  };
  
  const FIELDS = [
    { k:'adresse_ban', l:'Adresse', c:'text-truncate', s:'max-width:200px' },
    { k:'type_batiment', l:'Type', f: F.cap },
    { k:'surface_habitable_logement', l:'Surf.', c:'text-end font-monospace', f: v=>F.num(v)+' m²' },
    { k:'annee_construction', l:'Année', c:'text-center', f: (v,i)=>v||i.periode_construction||'-' },
    { k:'numero_dpe', l:'N° DPE', c:'font-monospace small', t:'dpe', f: v=>`<a href="https://data.ademe.fr/datasets/dpe03existant/full?p=%2Fdata-fair%2Fembed%2Fdataset%2Fdpe03existant%2Ftable&q=${v}" target="_blank">${v}</a>` },
    { k:'etiquette_dpe', l:'DPE', c:'text-center', f: F.bad },
    { k:'etiquette_ges', l:'GES', c:'text-center', t:'ges', f: F.bad },
    { k:'conso_5_usages_par_m2_ep', l:'Conso', c:'text-end font-monospace', t:'conso', f: v=>F.num(v) },
    { k:'date_etablissement_dpe', l:'Date', c:'text-center', f: v=>v?new Date(v).toLocaleDateString():'-' }
  ];

  let appData = [], sortState = {};

  const App = {
    init: () => {
      const d = new Date(); $('dEnd').valueAsDate = d; d.setMonth(d.getMonth()-1); $('dStart').valueAsDate = d;
      
      App.map = L.map('map', { fullscreenControl: true }).setView([46.6, 1.9], 6);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(App.map);
      App.markers = L.layerGroup().addTo(App.map);

      // Fix map resize
      document.querySelector('button[data-bs-target="#mapView"]').addEventListener('shown.bs.tab', () => {
         setTimeout(() => { App.map.invalidateSize(); }, 100);
      });

      const thead = $('table').tHead.insertRow();
      FIELDS.forEach(fd => {
        if(fd.t) $('colToggles').innerHTML += `<li><label class="dropdown-item"><input type="checkbox" checked onchange="App.toggleCol('${fd.t}', this.checked)"> ${fd.l}</label></li>`;
        const th = document.createElement('th');
        th.className = `sortable ${fd.t||''}`; th.innerHTML = fd.l; th.onclick = () => App.sort(fd.k);
        thead.appendChild(th);
      });
      thead.innerHTML += '<th class="text-center">Map</th>';

      $('searchBtn').onclick = App.search;
    },

    search: async () => {
      $('msg').innerHTML = '<div class="spinner-border text-primary"></div>'; $('resBox').classList.add('d-none');
      
      const q = new URLSearchParams({ size: $('limit').value, select: FIELDS.map(x=>x.k).join(',')+',code_postal_ban,_geopoint,periode_construction' });
      const add = (k, v) => v && q.append(k, v);
      
      const ps = $('postal').value.split(/[\s,]+/).filter(Boolean);
      const types = ['tApp','tMai','tImm'].filter(id=>$(id).checked).map(id=>$(id).value);
      const grades = ['gA','gB','gC','gD','gE','gF','gG'].filter(id=>$(id).checked).map(id=>$(id).value);

      const qs = [];
      if(ps.length) qs.push(`(${ps.map(c=>`code_postal_brut:${c}`).join(' OR ')})`);
      if(types.length) qs.push(`(${types.map(t=>`type_batiment:${t}`).join(' OR ')})`);
      if(grades.length) qs.push(`(${grades.map(g=>`etiquette_dpe:${g}`).join(' OR ')})`);
      if(qs.length) q.append('qs', qs.join(' AND '));
      
      [['date_etablissement_dpe_gte', $('dStart').value], ['date_etablissement_dpe_lte', $('dEnd').value],
       ['surface_habitable_logement_gte', $('sMin').value], ['surface_habitable_logement_lte', $('sMax').value]].forEach(p => add(...p));

      $('badges').innerHTML = types.map(t=>`<span class="badge bg-info text-dark me-1">${t}</span>`).join('') + (ps[0] ? `<span class="badge bg-dark">${ps[0]}</span>` : '');

      try {
        const res = await fetch(`${C.api}?${q}`);
        appData = (await res.json()).results || [];
        App.render(); App.mapRender();
        $('msg').classList.add('d-none'); $('resBox').classList.remove('d-none');
      } catch(e) { $('msg').textContent = 'Erreur API'; }
    },

    render: () => {
      $('count').textContent = appData.length + ' résultats';
      $('table').tBodies[0].innerHTML = appData.map(d => `<tr>
        ${FIELDS.map(f => `<td class="${f.c||''} ${f.t||''}" style="${f.s||''}">${f.f ? f.f(d[f.k], d) : (d[f.k]||'')}</td>`).join('')}
        <td class="text-center"><button class="btn btn-sm btn-light text-primary" onclick="App.zoom('${d.numero_dpe}')"><i class="bi bi-geo"></i></button></td>
      </tr>`).join('');
    },

    sort: (k) => {
      const o = sortState.k === k && sortState.o === 1 ? -1 : 1; sortState = {k, o};
      appData.sort((a,b) => (a[k] > b[k] ? 1 : -1) * o);
      App.render();
    },

    toggleCol: (cls, show) => {
      document.querySelectorAll('.'+cls).forEach(el => el.classList.toggle('col-hidden', !show));
    },

    mapRender: () => {
      App.markers.clearLayers(); const b = [];
      appData.forEach(d => {
        if(!d._geopoint) return;
        const [lat, lng] = d._geopoint.split(',').map(Number);
        
        // --- MODULAR POPUP BUILDER ---
        const rows = FIELDS.slice(1).map(f => // Skip address (index 0)
          `<tr><td class="text-muted pe-2">${f.l}:</td><td class="fw-bold text-end">${f.f ? f.f(d[f.k], d) : (d[f.k]||'-')}</td></tr>`
        ).join('');
        const html = `<div class="fw-bold border-bottom mb-2 pb-1">${d.adresse_ban||'?'}</div><table class="table table-sm table-borderless m-0 small">${rows}</table>`;
        // -----------------------------

        const icon = (d.type_batiment||'').includes('ison') ? 'house-fill' : 'building';
        const color = C.cols[d.etiquette_dpe] || '#ccc';
        const m = L.marker([lat, lng], {
          icon: L.divIcon({ html: `<div class="custom-pin" style="background:${color};width:30px;height:30px"><i class="bi bi-${icon}"></i></div>`, className:'' })
        }).bindPopup(html);
        m.did = d.numero_dpe; App.markers.addLayer(m); b.push([lat, lng]);
      });
      if(b.length) App.map.fitBounds(b);
    },

    zoom: (id) => {
      const tab = new bootstrap.Tab(document.querySelector('button[data-bs-target="#mapView"]')); tab.show();
      App.markers.eachLayer(l => { if(l.did === id) { App.map.setView(l.getLatLng(), 16); l.openPopup(); } });
    }
  };

  document.addEventListener('DOMContentLoaded', App.init);
</script>
</body>
</html>